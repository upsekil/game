<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Hero - Edisi Juara</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #fff7ed; /* Orange tint background warm */
            touch-action: manipulation;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        h1, h2, h3, .fun-font {
            font-family: 'Fredoka', sans-serif;
        }
        
        /* Animations */
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-bounce-slow {
            animation: bounce-slow 3s infinite ease-in-out;
        }
        
        @keyframes pop-in {
            0% { transform: scale(0); opacity: 0; }
            80% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-in {
            animation: pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .click-effect:active {
            transform: scale(0.95);
        }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #fdba74; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }

        /* Level Bar Gradient */
        .xp-gradient {
            background: linear-gradient(90deg, #f59e0b 0%, #f97316 100%);
        }

        /* Tutorial Cards Hover */
        .tut-card { transition: transform 0.2s; }
        .tut-card:hover { transform: translateY(-2px); }
        
        /* SVG Line Animation */
        .draw-line {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: dash 2s linear forwards;
        }
        @keyframes dash {
            to { stroke-dashoffset: 0; }
        }
    </style>
</head>
<body class="bg-orange-50 min-h-screen flex items-center justify-center p-2 sm:p-4">

    <!-- Confetti Canvas -->
    <canvas id="confetti-canvas" class="fixed top-0 left-0 w-full h-full pointer-events-none z-50"></canvas>

    <!-- Modal Level Up -->
    <div id="levelup-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-8 text-center max-w-sm w-full border-4 border-yellow-400 shadow-2xl pop-in relative overflow-hidden">
            <div class="absolute inset-0 bg-yellow-50 -z-10"></div>
            <div class="text-6xl mb-2">üåüüÜôüåü</div>
            <h2 class="text-3xl font-black text-yellow-600 fun-font mb-2">LEVEL UP!</h2>
            <p class="text-gray-600 mb-6 font-bold">Kamu naik ke Level <span id="new-level-disp" class="text-2xl text-orange-600">2</span>!</p>
            <button onclick="closeLevelModal()" class="w-full py-3 rounded-xl bg-orange-500 text-white font-bold text-lg shadow-lg hover:bg-orange-600 transition-all click-effect">
                Lanjut Main! üöÄ
            </button>
        </div>
    </div>

    <!-- Modal Time's Up -->
    <div id="timeout-modal" class="fixed inset-0 bg-slate-900/90 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-white rounded-3xl p-8 text-center max-w-sm w-full border-4 border-red-400 shadow-2xl relative overflow-hidden">
            <div class="text-6xl mb-4">üò¥</div>
            <h2 class="text-3xl font-black text-slate-800 fun-font mb-2">Waktunya Istirahat!</h2>
            <p class="text-gray-500 mb-6 font-medium">Jatah main kamu sudah habis.<br>Simpan matamu dan main lagi besok ya!</p>
            <div class="text-xs text-gray-400 mt-4 border-t pt-4">Refresh halaman untuk sesi baru.</div>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="app-container" class="w-full max-w-lg h-[90vh] sm:h-[850px] bg-white rounded-3xl shadow-2xl overflow-hidden border-4 border-b-8 border-orange-400 relative flex flex-col">
        
        <!-- HEADER -->
        <div id="app-header" class="bg-orange-500 p-3 sm:p-4 text-white shrink-0 z-20 shadow-md hidden">
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-2" onclick="showStats()">
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-orange-500 border-2 border-orange-200 shadow-sm">
                        <i class="ph-fill ph-star text-2xl"></i>
                    </div>
                    <div>
                        <div id="user-name-disp" class="font-bold fun-font leading-none text-lg">Juara</div>
                        <div class="text-xs text-orange-100 font-bold tracking-wide">LVL <span id="user-level-disp">1</span></div>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <div class="bg-orange-600 px-3 py-1 rounded-full flex items-center gap-1 border border-orange-400">
                        <i class="ph-bold ph-clock text-yellow-200"></i>
                        <span id="session-timer" class="font-mono font-bold text-sm">00:00</span>
                    </div>
                    <button onclick="logoutUser()" class="w-10 h-10 bg-red-500 rounded-full flex items-center justify-center hover:bg-red-600 transition-colors border border-red-400 shadow-sm" title="Keluar">
                        <i class="ph-bold ph-sign-out text-white text-lg"></i>
                    </button>
                </div>
            </div>
            <div class="relative">
                <div class="flex justify-between text-[10px] font-bold text-orange-100 mb-1 px-1"><span>XP PROGRESS</span><span id="xp-text">0/100</span></div>
                <div class="w-full h-2 bg-orange-700 rounded-full overflow-hidden border border-orange-400/50">
                    <div id="xp-bar" class="h-full xp-gradient transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- SCROLLABLE CONTENT -->
        <div id="main-scroll" class="flex-1 overflow-y-auto relative bg-orange-50 custom-scroll scroll-smooth">
            
            <!-- 1. LAYAR LOGIN -->
            <div id="screen-login" class="p-8 h-full flex flex-col items-center justify-center text-center bg-orange-50">
                <div class="animate-bounce-slow mb-6">
                    <span class="text-9xl drop-shadow-xl">üåü</span>
                </div>
                <h1 class="text-3xl font-black text-orange-600 fun-font mb-2">Halo Juara!</h1>
                <p class="text-gray-500 mb-6 font-medium">Ayo tunjukkan kehebatanmu.</p>
                <div class="w-full space-y-4">
                    <div class="text-left">
                        <label class="text-xs font-bold text-gray-400 ml-1 uppercase">Nama Kamu</label>
                        <input type="text" id="input-name" placeholder="Ketik nama..." class="w-full p-3 text-lg font-bold rounded-xl border-2 border-orange-200 focus:border-orange-500 focus:outline-none text-orange-800 bg-white shadow-sm">
                    </div>
                    <div class="text-left">
                        <label class="text-xs font-bold text-gray-400 ml-1 uppercase">Waktu Belajar</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="selectTime(10, this)" class="time-btn p-2 rounded-xl border-2 border-gray-200 bg-white text-gray-500 font-bold hover:bg-orange-50 hover:border-orange-300">10 Mnt</button>
                            <button onclick="selectTime(20, this)" class="time-btn p-2 rounded-xl border-2 border-orange-500 bg-orange-500 text-white font-bold shadow-md">20 Mnt</button>
                            <button onclick="selectTime(30, this)" class="time-btn p-2 rounded-xl border-2 border-gray-200 bg-white text-gray-500 font-bold hover:bg-orange-50 hover:border-orange-300">30 Mnt</button>
                        </div>
                    </div>
                    <button onclick="saveNameAndStart()" class="w-full py-4 mt-4 rounded-2xl bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold text-xl shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all">MULAI! üöÄ</button>
                    
                    <div class="mt-8 text-xs text-gray-400 font-bold">
                        Developer by <a href="https://upsekil.com" class="text-orange-500 hover:underline">upsekil.com</a><br>
                        Made with love by AI Gemini
                    </div>
                </div>
            </div>

            <!-- 2. MENU UTAMA -->
            <div id="screen-menu" class="hidden p-6 sm:p-8 min-h-full">
                <div class="bg-gradient-to-br from-orange-400 to-red-500 text-white rounded-2xl p-6 mb-6 text-center shadow-lg relative overflow-hidden">
                    <i class="ph-duotone ph-star absolute -right-2 -bottom-2 text-8xl text-white opacity-20"></i>
                    <h2 class="text-2xl font-bold fun-font mb-1">Markas Juara</h2>
                    <p class="text-orange-100 text-sm">Pilih misi belajarmu hari ini.</p>
                </div>

                <!-- Math Grid -->
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 ml-1">Matematika Dasar</h3>
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <button onclick="startGame('add')" class="click-effect p-3 rounded-2xl bg-white border-b-4 border-2 border-green-100 flex flex-col items-center gap-1 hover:border-green-300 transition-all">
                        <span class="text-3xl">‚ûï</span><span class="font-bold text-green-700 text-sm">Tambah</span>
                    </button>
                    <button onclick="startGame('subtract')" class="click-effect p-3 rounded-2xl bg-white border-b-4 border-2 border-red-100 flex flex-col items-center gap-1 hover:border-red-300 transition-all">
                        <span class="text-3xl">‚ûñ</span><span class="font-bold text-red-700 text-sm">Kurang</span>
                    </button>
                    <button onclick="startGame('multiply')" class="click-effect p-3 rounded-2xl bg-white border-b-4 border-2 border-yellow-100 flex flex-col items-center gap-1 hover:border-yellow-300 transition-all">
                        <span class="text-3xl">‚úñÔ∏è</span><span class="font-bold text-yellow-700 text-sm">Kali</span>
                    </button>
                    <button onclick="startGame('divide')" class="click-effect p-3 rounded-2xl bg-white border-b-4 border-2 border-purple-100 flex flex-col items-center gap-1 hover:border-purple-300 transition-all">
                        <span class="text-3xl">‚ûó</span><span class="font-bold text-purple-700 text-sm">Bagi</span>
                    </button>
                </div>

                <!-- Knowledge Grid -->
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 ml-1">Keahlian Khusus</h3>
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <button onclick="startGame('clock')" class="click-effect p-3 rounded-2xl bg-white border-b-4 border-2 border-cyan-100 flex flex-col items-center gap-1 hover:border-cyan-300 group shadow-sm transition-all">
                        <div class="w-10 h-10 bg-cyan-100 text-cyan-600 rounded-full flex items-center justify-center text-xl group-hover:scale-110 transition-transform"><i class="ph-bold ph-clock"></i></div>
                        <span class="font-bold text-cyan-800 text-sm">Baca Jam</span>
                    </button>
                    <button onclick="startGame('units')" class="click-effect p-3 rounded-2xl bg-white border-b-4 border-2 border-indigo-100 flex flex-col items-center gap-1 hover:border-indigo-300 group shadow-sm transition-all">
                        <div class="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-xl group-hover:scale-110 transition-transform"><i class="ph-bold ph-ruler"></i></div>
                        <span class="font-bold text-indigo-800 text-sm">Satuan</span>
                    </button>
                </div>

                <!-- Footer Menus -->
                <div class="space-y-3 mb-8">
                    <button onclick="showScreen('tutorial-menu')" class="w-full click-effect p-4 rounded-2xl bg-white border-2 border-gray-100 shadow-sm flex items-center gap-4 hover:border-blue-200 transition-all">
                        <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center"><i class="ph-fill ph-book-open-text text-xl"></i></div>
                        <div class="text-left flex-1">
                            <h3 class="font-bold text-gray-800">Buku Pintar</h3>
                            <p class="text-xs text-gray-500">Trik & Metode Visual</p>
                        </div>
                        <i class="ph-bold ph-caret-right text-gray-300"></i>
                    </button>
                    <button onclick="showStats()" class="w-full click-effect p-4 rounded-2xl bg-white border-2 border-gray-100 shadow-sm flex items-center gap-4 hover:border-orange-200 transition-all">
                        <div class="w-10 h-10 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center"><i class="ph-fill ph-trophy text-xl"></i></div>
                        <div class="text-left flex-1">
                            <h3 class="font-bold text-gray-800">Rapor Juara</h3>
                            <p class="text-xs text-gray-500">Cek levelmu di sini</p>
                        </div>
                        <i class="ph-bold ph-caret-right text-gray-300"></i>
                    </button>
                </div>

                <div class="text-center text-[10px] text-gray-400 font-bold mt-4 pb-4">
                    Developer by <a href="https://upsekil.com" class="text-orange-400 hover:underline">upsekil.com</a><br>
                    Made with love by AI Gemini
                </div>
            </div>

            <!-- 3. LAYAR GAMEPLAY -->
            <div id="screen-game" class="hidden p-6 text-center h-full flex flex-col justify-center">
                <div class="w-full bg-gray-200 rounded-full h-3 mb-8">
                    <div id="game-timer-bar" class="bg-orange-500 h-3 rounded-full transition-all duration-700" style="width: 100%"></div>
                </div>
                <div id="question-container" class="mb-8 relative pop-in flex justify-center">
                    <div id="text-question-box" class="inline-block bg-white px-8 py-6 rounded-3xl border-b-8 border-r-4 border-2 border-gray-200 shadow-sm min-w-[220px]">
                        <h2 id="question-text" class="text-4xl sm:text-5xl font-black text-gray-800 tracking-wider font-mono">0 + 0</h2>
                    </div>
                    <div id="clock-question-box" class="hidden bg-white p-4 rounded-full border-4 border-sky-300 shadow-lg relative">
                        <canvas id="game-clock-canvas" width="220" height="220"></canvas>
                        <div class="absolute inset-0 rounded-full border-4 border-white/30 pointer-events-none"></div>
                    </div>
                </div>
                <div id="feedback-msg" class="h-8 mb-4 font-bold text-xl transition-all opacity-0"></div>
                <div id="options-grid" class="grid grid-cols-2 gap-4 max-w-sm mx-auto w-full"></div>
                <button onclick="goHome()" class="w-full mt-6 py-4 rounded-xl bg-gray-100 border-2 border-gray-200 text-gray-500 font-bold text-lg hover:bg-red-50 hover:text-red-500 hover:border-red-200 transition-all flex items-center justify-center gap-2 click-effect">
                    <i class="ph-bold ph-x-circle text-2xl"></i> Batalkan Misi
                </button>
            </div>

            <!-- 4. HASIL & STATS -->
            <div id="screen-result" class="hidden p-8 text-center flex flex-col items-center justify-center min-h-full">
                <div id="result-emoji" class="text-8xl animate-bounce mb-4">üèÜ</div>
                <h2 class="text-3xl font-bold text-gray-800 mb-2">Misi Selesai!</h2>
                <div class="bg-yellow-50 p-4 rounded-2xl border-2 border-yellow-200 w-full mb-6">
                    <div class="flex justify-between items-center mb-2 px-4"><span class="text-gray-500 font-bold text-sm">Skor Misi</span><span id="final-score" class="text-2xl font-black text-gray-800">0</span></div>
                    <div class="flex justify-between items-center px-4"><span class="text-orange-500 font-bold text-sm">Power XP</span><span id="final-xp" class="text-2xl font-black text-orange-600">+0 XP</span></div>
                </div>
                <button onclick="startGame(currentMode)" class="w-full py-3 rounded-xl bg-orange-500 text-white font-bold text-lg shadow-lg hover:bg-orange-600 mb-3 click-effect">Main Lagi üîÑ</button>
                <button onclick="goHome()" class="w-full py-3 rounded-xl bg-gray-100 text-gray-600 font-bold text-lg hover:bg-gray-200">Menu Utama üè†</button>
            </div>

            <div id="screen-stats" class="hidden p-6 sm:p-8 min-h-full bg-orange-50">
                <div class="text-center mb-6"><h2 class="text-2xl font-bold text-gray-800 fun-font">Rapor Juara</h2></div>
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-orange-200 text-center mb-6">
                    <div class="w-20 h-20 bg-orange-100 text-orange-500 rounded-full flex items-center justify-center mx-auto mb-3 text-4xl">üåü</div>
                    <h3 id="stats-name" class="text-xl font-bold text-gray-800">Nama</h3>
                    <div class="flex justify-center gap-4 mt-4">
                        <div class="text-center"><div class="text-xs text-gray-400 font-bold uppercase">Level</div><div id="stats-level" class="text-2xl font-black text-blue-600">1</div></div>
                        <div class="w-px bg-gray-200"></div>
                        <div class="text-center"><div class="text-xs text-gray-400 font-bold uppercase">Total XP</div><div id="stats-xp" class="text-2xl font-black text-orange-500">0</div></div>
                    </div>
                </div>
                <div class="space-y-3">
                    <button onclick="goHome()" class="w-full py-3 rounded-xl bg-blue-500 text-white font-bold hover:bg-blue-600">Kembali</button>
                    <button onclick="resetProgress()" class="w-full py-3 text-sm text-red-400 font-bold hover:text-red-600 underline">Reset Data</button>
                </div>
            </div>

            <!-- 5. MENU BUKU PINTAR -->
            <div id="screen-tutorial-menu" class="hidden p-6 min-h-full">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Buku Pintar</h2>
                    <p class="text-sm text-gray-500">Kumpulan Rahasia Matematika</p>
                </div>
                <div class="space-y-3">
                    <!-- NEW: METODE CHINA -->
                    <button onclick="openTutorial('china')" class="w-full p-4 bg-white border-2 border-rose-100 rounded-xl flex items-center gap-3 hover:bg-rose-50 transition-colors shadow-sm group">
                        <div class="w-12 h-12 rounded-full bg-rose-500 text-white flex items-center justify-center font-bold text-2xl group-hover:scale-110 transition-transform"><i class="ph-bold ph-abacus"></i></div>
                        <div class="flex-1 text-left">
                            <span class="font-bold text-gray-700 block">Trik Tiongkok</span>
                            <span class="text-xs text-gray-400">Metode Garis & Jari</span>
                        </div>
                        <i class="ph-bold ph-caret-right text-gray-300"></i>
                    </button>

                    <div class="border-t border-gray-200 my-2 text-xs text-center text-gray-400 font-bold uppercase tracking-widest pt-2">Dasar</div>

                    <!-- Math -->
                    <button onclick="openTutorial('add')" class="w-full p-3 bg-white border border-gray-200 rounded-xl flex items-center gap-3 hover:bg-green-50 transition-colors">
                        <div class="w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center font-bold">‚ûï</div>
                        <span class="font-bold text-gray-600 flex-1 text-left">Penjumlahan</span>
                    </button>
                    <button onclick="openTutorial('subtract')" class="w-full p-3 bg-white border border-gray-200 rounded-xl flex items-center gap-3 hover:bg-red-50 transition-colors">
                        <div class="w-8 h-8 rounded-full bg-red-100 text-red-600 flex items-center justify-center font-bold">‚ûñ</div>
                        <span class="font-bold text-gray-600 flex-1 text-left">Pengurangan</span>
                    </button>
                     <button onclick="openTutorial('multiply')" class="w-full p-3 bg-white border border-gray-200 rounded-xl flex items-center gap-3 hover:bg-yellow-50 transition-colors">
                        <div class="w-8 h-8 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center font-bold">‚úñÔ∏è</div>
                        <span class="font-bold text-gray-600 flex-1 text-left">Perkalian</span>
                    </button>
                    <button onclick="openTutorial('divide')" class="w-full p-3 bg-white border border-gray-200 rounded-xl flex items-center gap-3 hover:bg-purple-50 transition-colors">
                        <div class="w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center font-bold">‚ûó</div>
                        <span class="font-bold text-gray-600 flex-1 text-left">Pembagian</span>
                    </button>

                     <div class="border-t border-gray-200 my-2 text-xs text-center text-gray-400 font-bold uppercase tracking-widest pt-2">Lainnya</div>

                     <button onclick="openTutorial('clock')" class="w-full p-3 bg-white border border-gray-200 rounded-xl flex items-center gap-3 hover:bg-cyan-50 transition-colors">
                        <div class="w-8 h-8 rounded-full bg-cyan-100 text-cyan-600 flex items-center justify-center font-bold"><i class="ph-bold ph-clock"></i></div>
                        <span class="font-bold text-gray-600 flex-1 text-left">Membaca Jam</span>
                    </button>
                    <button onclick="openTutorial('units')" class="w-full p-3 bg-white border border-gray-200 rounded-xl flex items-center gap-3 hover:bg-indigo-50 transition-colors">
                        <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold"><i class="ph-bold ph-ruler"></i></div>
                        <span class="font-bold text-gray-600 flex-1 text-left">Satuan Ukur</span>
                    </button>
                </div>
                <button onclick="goHome()" class="mt-8 w-full py-3 text-gray-500 font-bold hover:text-blue-500">Kembali</button>
            </div>

            <!-- 6. DETAIL BUKU PINTAR -->
            <div id="screen-tutorial-read" class="hidden p-6 pb-20">
                <div class="flex items-center gap-3 mb-6 sticky top-0 bg-orange-50/95 backdrop-blur py-2 z-10 border-b border-orange-200">
                    <button onclick="showScreen('tutorial-menu')" class="w-10 h-10 rounded-full bg-white border border-orange-200 flex items-center justify-center hover:bg-orange-100 text-gray-600 transition-colors">
                        <i class="ph-bold ph-arrow-left"></i>
                    </button>
                    <div>
                        <h2 id="tutorial-title" class="text-xl font-bold text-gray-800 leading-tight">Judul</h2>
                    </div>
                </div>
                <div id="tutorial-content-body" class="space-y-6"></div>
                <div class="mt-10 pt-6 border-t border-gray-200 text-center">
                    <button id="tutorial-play-btn" class="w-full py-4 rounded-xl font-bold text-white shadow-lg transition-all pop-effect flex items-center justify-center gap-2 hover:shadow-xl hover:-translate-y-0.5">
                        <i class="ph-bold ph-play-circle text-xl"></i> Mulai Latihan
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- DATA BUKU PINTAR LENGKAP ---
        const tutorialData = {
            china: {
                title: "Trik Tiongkok (Visual)",
                theme: "rose",
                content: [
                    {
                        header: "1. Perkalian Garis (Stick)",
                        body: "Menghitung perkalian tanpa menghafal! Cukup gambar garis lurus dan hitung titik temunya.",
                        example: `
                        <div class="text-center font-bold text-lg mb-2">2 x 3 = 6</div>
                        <svg width="100%" height="120" viewBox="0 0 200 120" class="bg-white rounded-lg border border-gray-200 mx-auto">
                            <!-- Horizontal (2) -->
                            <line x1="40" y1="40" x2="160" y2="40" stroke="#ef4444" stroke-width="6" stroke-linecap="round" class="draw-line" />
                            <line x1="40" y1="80" x2="160" y2="80" stroke="#ef4444" stroke-width="6" stroke-linecap="round" class="draw-line" style="animation-delay: 0.5s"/>
                            <!-- Vertical (3) -->
                            <line x1="70" y1="20" x2="70" y2="100" stroke="#3b82f6" stroke-width="6" stroke-linecap="round" class="draw-line" style="animation-delay: 1s"/>
                            <line x1="100" y1="20" x2="100" y2="100" stroke="#3b82f6" stroke-width="6" stroke-linecap="round" class="draw-line" style="animation-delay: 1.2s"/>
                            <line x1="130" y1="20" x2="130" y2="100" stroke="#3b82f6" stroke-width="6" stroke-linecap="round" class="draw-line" style="animation-delay: 1.4s"/>
                            <!-- Dots -->
                            <circle cx="70" cy="40" r="5" fill="#fbbf24" stroke="black" stroke-width="1" />
                            <circle cx="100" cy="40" r="5" fill="#fbbf24" stroke="black" stroke-width="1" />
                            <circle cx="130" cy="40" r="5" fill="#fbbf24" stroke="black" stroke-width="1" />
                            <circle cx="70" cy="80" r="5" fill="#fbbf24" stroke="black" stroke-width="1" />
                            <circle cx="100" cy="80" r="5" fill="#fbbf24" stroke="black" stroke-width="1" />
                            <circle cx="130" cy="80" r="5" fill="#fbbf24" stroke="black" stroke-width="1" />
                        </svg>
                        <p class="mt-2 text-xs text-center text-gray-500">Ada 6 titik kuning = Jawabannya 6!</p>
                        `
                    },
                    {
                        header: "2. Jarimatika",
                        body: "Tanganmu adalah kalkulator! Gunakan dua tanganmu.",
                        example: `
                        <div class="flex justify-center gap-4 py-4">
                            <div class="text-center">
                                <i class="ph-fill ph-hand-palm text-6xl text-orange-400 rotate-12"></i>
                                <p class="font-bold text-gray-700">KIRI</p>
                                <p class="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded-full">Puluhan (10,20..)</p>
                            </div>
                            <div class="text-center">
                                <i class="ph-fill ph-hand-palm text-6xl text-green-400 -rotate-12 transform scale-x-[-1]"></i>
                                <p class="font-bold text-gray-700">KANAN</p>
                                <p class="text-xs bg-green-100 text-green-600 px-2 py-1 rounded-full">Satuan (1,2..)</p>
                            </div>
                        </div>
                        <p class="text-sm text-center">Jika Kiri buka 2 jari (20) dan Kanan buka 3 jari (3), artinya <strong>23</strong>.</p>
                        `
                    }
                ]
            },
            add: {
                title: "Trik Penjumlahan",
                theme: "green",
                content: [
                    {
                        header: "1. Simpan Angka Besar",
                        body: "Kalau menjumlahkan dua angka, simpan angka yang <strong>lebih besar</strong> di kepalamu, dan siapkan angka kecil di jarimu.",
                        example: "3 + 8 = ?<br>1. Simpan <strong>8</strong> di kepala.<br>2. Buka <strong>3</strong> jari.<br>3. Hitung maju: 9, 10, 11.<br>Hasil: <strong>11</strong>"
                    },
                    {
                        header: "2. Trik 'Teman 10'",
                        body: "Cari angka yang kalau dijumlahkan hasilnya 10. Ini mempercepat hitungan!",
                        example: "Pasangan Teman 10:<br>9+1 | 8+2 | 7+3 | 6+4 | 5+5"
                    }
                ]
            },
            subtract: {
                title: "Trik Pengurangan",
                theme: "red",
                content: [
                    {
                        header: "1. Hitung Mundur",
                        body: "Jika angka pengurangnya kecil (1, 2, atau 3), gunakan hitung mundur.",
                        example: "9 - 2 = ?<br>Sebut 9, mundur 2 langkah:<br>8... 7.<br>Hasil: <strong>7</strong>"
                    },
                    {
                        header: "2. Jarak Angka (Selisih)",
                        body: "Jika angkanya berdekatan, hitung <strong>maju</strong> dari angka kecil ke angka besar.",
                        example: "12 - 9 = ?<br>Dari 9 ke 12 butuh berapa langkah?<br>10... 11... 12.<br>Butuh 3 langkah. Jawabannya <strong>3</strong>."
                    }
                ]
            },
            multiply: {
                title: "Trik Perkalian",
                theme: "yellow",
                content: [
                    {
                        header: "1. Konsep Dasar",
                        body: "Perkalian adalah penjumlahan yang berulang.",
                        example: "3 x 4 artinya <strong>4-nya ada 3 kali</strong>.<br>4 + 4 + 4 = 12."
                    },
                    {
                        header: "2. Jari Sakti Perkalian 9",
                        body: "Gunakan 10 jarimu untuk perkalian 9 yang ajaib!",
                        example: "Mau hitung 9 x 4?<br>1. Buka 10 jari.<br>2. Lipat jari ke-4.<br>3. Kiri lipatan ada <strong>3</strong>, kanan ada <strong>6</strong>.<br>Gabung: <strong>36</strong>."
                    }
                ]
            },
            divide: {
                title: "Trik Pembagian",
                theme: "purple",
                content: [
                    {
                        header: "1. Konsep Berbagi",
                        body: "Bayangkan membagi permen ke temanmu secara adil.",
                        example: "10 : 2 artinya<br>10 permen dibagi ke 2 orang.<br>Setiap orang dapat <strong>5</strong>."
                    },
                    {
                        header: "2. Kebalikan Perkalian",
                        body: "Kalau kamu hafal perkalian, pembagian itu gampang!",
                        example: "20 : 4 = ?<br>Pikirkan: <strong>4 kali berapa biar jadi 20?</strong><br>Karena 4 x 5 = 20, maka 20 : 4 = <strong>5</strong>."
                    }
                ]
            },
            clock: {
                title: "Membaca Jam",
                theme: "cyan",
                content: [
                    {
                        header: "1. Jarum Pendek & Panjang",
                        body: "Jarum PENDEK menunjuk <strong>JAM</strong>.<br>Jarum PANJANG menunjuk <strong>MENIT</strong>."
                    },
                    {
                        header: "2. Menit Penting",
                        body: "Perhatikan posisi jarum panjang:",
                        example: "Angka 12 = Tepat (.00)<br>Angka 3 = Lewat seperempat (.15)<br>Angka 6 = Setengah (.30)<br>Angka 9 = Kurang seperempat (.45)"
                    }
                ]
            },
            units: {
                title: "Satuan Ukur",
                theme: "indigo",
                content: [
                    {
                        header: "1. Satuan Panjang",
                        body: "Ingat tangga satuan ini:",
                        example: "1 meter (m) = 100 cm<br>1 kilometer (km) = 1000 m"
                    },
                    {
                        header: "2. Berat & Waktu",
                        body: "Hafalan wajib sehari-hari:",
                        example: "1 kilogram (kg) = 1000 gram<br>1 jam = 60 menit<br>1 menit = 60 detik"
                    }
                ]
            }
        };

        // --- CORE FUNCTIONS ---
        const DEFAULT_PROFILE = { name: "", level: 1, xp: 0, total_score: 0 };
        let userProfile = JSON.parse(localStorage.getItem('mathHero_profile')) || DEFAULT_PROFILE;
        let selectedTime = 20; let sessionTimer = null; let timeRemaining = 0;

        function saveProfile() { localStorage.setItem('mathHero_profile', JSON.stringify(userProfile)); updateHeaderUI(); }
        function resetProgress() { if(confirm("Hapus semua data?")) { userProfile = {...DEFAULT_PROFILE}; localStorage.removeItem('mathHero_profile'); logoutUser(); } }
        function selectTime(min, btn) {
            selectedTime = min;
            document.querySelectorAll('.time-btn').forEach(b => { b.classList.remove('bg-orange-500','text-white'); b.classList.add('bg-white','text-gray-500'); });
            btn.classList.remove('bg-white','text-gray-500'); btn.classList.add('bg-orange-500','text-white');
        }
        function startSessionTimer() {
            if(sessionTimer) clearInterval(sessionTimer); timeRemaining = selectedTime * 60; updateTimerDisplay();
            sessionTimer = setInterval(() => { timeRemaining--; updateTimerDisplay(); if(timeRemaining <= 0) { clearInterval(sessionTimer); document.getElementById('timeout-modal').classList.remove('hidden'); } }, 1000);
        }
        function stopSessionTimer() { if(sessionTimer) clearInterval(sessionTimer); }
        function updateTimerDisplay() {
            const m = Math.floor(timeRemaining/60).toString().padStart(2,'0'); const s = (timeRemaining%60).toString().padStart(2,'0');
            document.getElementById('session-timer').textContent = `${m}:${s}`;
        }

        const screens = ['login', 'menu', 'game', 'result', 'stats', 'tutorial-menu', 'tutorial-read'];
        function showScreen(name) { screens.forEach(s => document.getElementById(`screen-${s}`).classList.add('hidden')); document.getElementById(`screen-${name}`).classList.remove('hidden'); document.getElementById('main-scroll').scrollTop = 0; }
        function saveNameAndStart() {
            const nm = document.getElementById('input-name').value.trim();
            if(nm) { userProfile.name = nm; saveProfile(); document.getElementById('app-header').classList.remove('hidden'); startSessionTimer(); goHome(); }
            else { document.getElementById('input-name').classList.add('border-red-500'); }
        }
        function logoutUser() { stopSessionTimer(); document.getElementById('app-header').classList.add('hidden'); showScreen('login'); }
        function goHome() { if(!userProfile.name) showScreen('login'); else { document.getElementById('app-header').classList.remove('hidden'); updateHeaderUI(); showScreen('menu'); } }
        function showStats() {
            document.getElementById('stats-name').textContent = userProfile.name; document.getElementById('stats-level').textContent = userProfile.level; document.getElementById('stats-xp').textContent = userProfile.total_score; showScreen('stats');
        }
        function calculateXPForNextLevel(lvl) { return lvl * 100; }
        function updateHeaderUI() {
            document.getElementById('user-name-disp').textContent = userProfile.name || "Juara"; document.getElementById('user-level-disp').textContent = userProfile.level;
            const need = calculateXPForNextLevel(userProfile.level);
            document.getElementById('xp-text').textContent = `${userProfile.xp}/${need}`; document.getElementById('xp-bar').style.width = `${(userProfile.xp/need)*100}%`;
        }
        function showLevelUpModal() { document.getElementById('levelup-modal').classList.remove('hidden'); }
        function closeLevelModal() { document.getElementById('levelup-modal').classList.add('hidden'); }
        function addXP(amt) {
            userProfile.xp += amt; userProfile.total_score += amt;
            if(userProfile.xp >= calculateXPForNextLevel(userProfile.level)) { userProfile.xp -= calculateXPForNextLevel(userProfile.level); userProfile.level++; showLevelUpModal(); playSound('levelup'); }
            saveProfile();
        }

        function openTutorial(type) {
            const data = tutorialData[type]; if (!data) return;
            const container = document.getElementById('tutorial-content-body'); const title = document.getElementById('tutorial-title'); const btn = document.getElementById('tutorial-play-btn');
            title.textContent = data.title;
            
            let colorClass = 'bg-blue-600';
            if (data.theme === 'rose') colorClass = 'bg-rose-500'; if (data.theme === 'green') colorClass = 'bg-green-500'; if (data.theme === 'red') colorClass = 'bg-red-500'; if (data.theme === 'yellow') colorClass = 'bg-yellow-500'; if (data.theme === 'purple') colorClass = 'bg-purple-600'; if (data.theme === 'cyan') colorClass = 'bg-cyan-600'; if (data.theme === 'indigo') colorClass = 'bg-indigo-600';

            btn.className = `w-full py-4 rounded-xl font-bold text-white shadow-lg transition-all pop-effect flex items-center justify-center gap-2 hover:shadow-xl hover:-translate-y-0.5 ${colorClass}`;
            btn.onclick = () => startGame(type === 'china' ? 'multiply' : type);

            container.innerHTML = '';
            data.content.forEach(section => {
                const card = document.createElement('div');
                let borderClass = 'border-l-4 border-blue-400'; let bgIcon = 'bg-blue-100 text-blue-600';
                if(data.theme === 'rose') { borderClass='border-l-4 border-rose-400'; bgIcon='bg-rose-100 text-rose-600'; }
                if(data.theme === 'green') { borderClass='border-l-4 border-green-400'; bgIcon='bg-green-100 text-green-600'; }
                if(data.theme === 'red') { borderClass='border-l-4 border-red-400'; bgIcon='bg-red-100 text-red-600'; }
                if(data.theme === 'yellow') { borderClass='border-l-4 border-yellow-400'; bgIcon='bg-yellow-100 text-yellow-600'; }
                if(data.theme === 'purple') { borderClass='border-l-4 border-purple-400'; bgIcon='bg-purple-100 text-purple-600'; }
                if(data.theme === 'cyan') { borderClass='border-l-4 border-cyan-400'; bgIcon='bg-cyan-100 text-cyan-600'; }
                if(data.theme === 'indigo') { borderClass='border-l-4 border-indigo-400'; bgIcon='bg-indigo-100 text-indigo-600'; }

                card.className = `tut-card bg-white p-5 rounded-xl shadow-sm border border-gray-100 ${borderClass}`;
                let html = `<div class="flex items-center gap-3 mb-3"><div class="w-8 h-8 rounded-full ${bgIcon} flex items-center justify-center shrink-0"><i class="ph-bold ph-lightbulb"></i></div><h3 class="font-bold text-lg text-gray-800 leading-tight">${section.header}</h3></div><p class="text-gray-600 text-sm leading-relaxed mb-3 pl-11">${section.body}</p>`;
                if(section.example) html += `<div class="ml-11 bg-gray-50 border border-gray-200 rounded-lg p-3 text-sm font-mono text-gray-700 leading-relaxed overflow-hidden">${section.example}</div>`;
                card.innerHTML = html; container.appendChild(card);
            });
            showScreen('tutorial-read');
        }

        // --- GAME LOGIC ---
        let currentMode = ''; let currentScore = 0; let earnedXP = 0; let questionCount = 0; const maxQuestions = 5; let correctAnswer = ""; let isGameActive = false;
        function startGame(mode) { currentMode = mode; currentScore = 0; earnedXP = 0; questionCount = 0; isGameActive = true; showScreen('game'); nextQuestion(); }
        function drawClock(hours, minutes) {
            const canvas = document.getElementById('game-clock-canvas'); const ctx = canvas.getContext('2d');
            const radius = canvas.height / 2; ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.translate(radius, radius); const r = radius * 0.90;
            ctx.beginPath(); ctx.arc(0, 0, r, 0, 2*Math.PI); ctx.fillStyle = 'white'; ctx.fill(); ctx.strokeStyle = '#3b82f6'; ctx.lineWidth = 8; ctx.stroke();
            ctx.beginPath(); ctx.arc(0, 0, r*0.05, 0, 2*Math.PI); ctx.fillStyle = '#333'; ctx.fill();
            ctx.font = radius*0.15 + "px arial"; ctx.textBaseline="middle"; ctx.textAlign="center"; ctx.fillStyle = '#333';
            for(let num = 1; num <= 12; num++){ let ang = num * Math.PI / 6; ctx.rotate(ang); ctx.translate(0, -r*0.85); ctx.rotate(-ang); ctx.fillText(num.toString(), 0, 0); ctx.rotate(ang); ctx.translate(0, r*0.85); ctx.rotate(-ang); }
            let hPos = (hours % 12)*Math.PI/6 + (minutes*Math.PI/(6*60)); drawHand(ctx, hPos, r*0.5, 6, '#1e3a8a');
            let mPos = (minutes*Math.PI/30); drawHand(ctx, mPos, r*0.75, 4, '#ef4444'); ctx.translate(-radius, -radius);
        }
        function drawHand(ctx, pos, length, width, color) { ctx.beginPath(); ctx.lineWidth = width; ctx.lineCap = "round"; ctx.strokeStyle = color; ctx.moveTo(0,0); ctx.rotate(pos); ctx.lineTo(0, -length); ctx.stroke(); ctx.rotate(-pos); }

        function generateNumbers() {
            const textBox = document.getElementById('text-question-box'); const clockBox = document.getElementById('clock-question-box'); const qText = document.getElementById('question-text');
            if (currentMode === 'clock') {
                textBox.classList.add('hidden'); clockBox.classList.remove('hidden');
                const h = Math.floor(Math.random() * 12) + 1; const m = Math.floor(Math.random() * 4) * 15;
                drawClock(h, m); return { type: 'clock', a: `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}` };
            } else {
                textBox.classList.remove('hidden'); clockBox.classList.add('hidden');
                if (currentMode === 'units') {
                    const type = Math.floor(Math.random() * 3); let val = Math.floor(Math.random() * 9) + 1;
                    if(type === 0) { qText.textContent = `${val} m = ... cm`; return { a: val * 100 }; } 
                    else if (type === 1) { qText.textContent = `${val} kg = ... g`; return { a: val * 1000 }; } 
                    else { qText.textContent = `${val} jam = ... mnt`; return { a: val * 60 }; }
                } else {
                    let n1, n2;
                    switch(currentMode) {
                        case 'add': n1=Math.floor(Math.random()*20)+2; n2=Math.floor(Math.random()*20)+2; qText.textContent=`${n1} + ${n2}`; return {a: n1+n2};
                        case 'subtract': n1=Math.floor(Math.random()*20)+5; n2=Math.floor(Math.random()*n1); qText.textContent=`${n1} - ${n2}`; return {a: n1-n2};
                        case 'multiply': n1=Math.floor(Math.random()*9)+2; n2=Math.floor(Math.random()*9)+2; qText.textContent=`${n1} √ó ${n2}`; return {a: n1*n2};
                        case 'divide': n2=Math.floor(Math.random()*8)+2; let ans=Math.floor(Math.random()*9)+2; n1=n2*ans; qText.textContent=`${n1} : ${n2}`; return {a: ans};
                    }
                }
            }
        }

        function nextQuestion() {
            if(questionCount >= maxQuestions) { endGame(); return; }
            questionCount++; document.getElementById('game-timer-bar').style.width = `${((maxQuestions-questionCount+1)/maxQuestions)*100}%`;
            const q = generateNumbers(); correctAnswer = q.a; document.getElementById('feedback-msg').style.opacity = 0; generateOptions(correctAnswer, currentMode);
        }

        function generateOptions(correct, mode) {
            const grid = document.getElementById('options-grid'); grid.innerHTML = ''; let opts = new Set([correct]);
            while(opts.size < 4) {
                if (mode === 'clock') {
                    let fh = Math.floor(Math.random()*12)+1; let fm = Math.floor(Math.random()*4)*15; let fStr = `${fh.toString().padStart(2,'0')}:${fm.toString().padStart(2,'0')}`; if(fStr !== correct) opts.add(fStr);
                } else if (mode === 'units') {
                    let mag = correct >= 1000 ? 1000 : (correct >= 100 ? 100 : 10); let diff = (Math.floor(Math.random()*5)+1) * (mag/10); 
                    if(Math.random() > 0.5) diff = -diff; if(correct+diff > 0 && correct+diff !== correct) opts.add(correct+diff);
                } else {
                    let diff = Math.floor(Math.random()*10)-5; if(diff !== 0 && correct+diff >= 0) opts.add(correct+diff);
                }
            }
            Array.from(opts).sort(() => Math.random()-0.5).forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "py-4 bg-white border-2 border-orange-100 rounded-2xl text-2xl font-bold text-orange-600 shadow-sm hover:bg-orange-50 active:scale-95 transition-all";
                btn.textContent = opt; btn.onclick = () => checkAnswer(opt, btn); grid.appendChild(btn);
            });
        }

        function checkAnswer(val, btn) {
            const grid = document.getElementById('options-grid'); Array.from(grid.children).forEach(b => b.disabled = true); const fb = document.getElementById('feedback-msg');
            if (val === correctAnswer) {
                currentScore += 10; earnedXP += 15;
                btn.classList.replace('border-orange-100','border-green-500'); btn.classList.add('bg-green-50','text-green-600');
                fb.textContent = "Benar! +15 XP"; fb.className="h-8 mb-4 font-bold text-xl text-green-600 opacity-100"; playSound('correct');
            } else {
                btn.classList.replace('border-orange-100','border-red-500'); btn.classList.add('bg-red-50','text-red-600');
                fb.textContent = `Jawabannya ${correctAnswer}`; fb.className="h-8 mb-4 font-bold text-xl text-red-500 opacity-100"; playSound('wrong');
            }
            setTimeout(() => { if(isGameActive) nextQuestion(); }, 1200);
        }

        function endGame() { isGameActive = false; document.getElementById('final-score').textContent = currentScore; document.getElementById('final-xp').textContent = `+${earnedXP} XP`; showScreen('result'); if(earnedXP > 0) addXP(earnedXP); }

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) { if(audioCtx.state==='suspended')audioCtx.resume(); const osc=audioCtx.createOscillator(); const g=audioCtx.createGain(); osc.connect(g); g.connect(audioCtx.destination); const t=audioCtx.currentTime; if(type==='correct'){osc.freq=600;osc.frequency.setValueAtTime(600,t);osc.frequency.exponentialRampToValueAtTime(1000,t+0.1);g.gain.setValueAtTime(0.2,t);g.gain.linearRampToValueAtTime(0,t+0.3);osc.start(t);osc.stop(t+0.3);} else if(type==='wrong'){osc.type='sawtooth';osc.frequency.setValueAtTime(150,t);g.gain.setValueAtTime(0.2,t);g.gain.linearRampToValueAtTime(0,t+0.2);osc.start(t);osc.stop(t+0.2);} else if(type==='levelup'){[440,554,659,880].forEach((f,i)=>{const o=audioCtx.createOscillator();o.type='triangle';const gn=audioCtx.createGain();o.connect(gn);gn.connect(audioCtx.destination);o.frequency.value=f;gn.gain.setValueAtTime(0.1,t+i*0.1);gn.gain.linearRampToValueAtTime(0,t+i*0.1+0.4);o.start(t+i*0.1);o.stop(t+i*0.1+0.4);});} }
        const canvas = document.getElementById('confetti-canvas'); const ctx = canvas.getContext('2d'); let particles = [];
        window.addEventListener('resize', ()=> {canvas.width=window.innerWidth;canvas.height=window.innerHeight;}); canvas.width=window.innerWidth;canvas.height=window.innerHeight;
        function startConfetti() { particles=[]; for(let i=0;i<100;i++) particles.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height-canvas.height,color:['#FCD34D','#60A5FA','#F87171','#34D399'][Math.floor(Math.random()*4)],speed:Math.random()*5+2,angle:Math.random()*360,spin:Math.random()*10-5,w:10,h:10}); animateConfetti(); }
        function animateConfetti() { if(particles.length>0){ctx.clearRect(0,0,canvas.width,canvas.height);particles.forEach((p,i)=>{p.y+=p.speed;p.angle+=p.spin;ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.angle*Math.PI/180);ctx.fillStyle=p.color;ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h);ctx.restore();if(p.y>canvas.height)particles.splice(i,1);});requestAnimationFrame(animateConfetti);}else{ctx.clearRect(0,0,canvas.width,canvas.height);} }

        window.onload = () => { if(userProfile.name){ document.getElementById('input-name').value=userProfile.name; showScreen('login'); } else { showScreen('login'); } }
    </script>
</body>
</html>